name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  # Step 1: Write tests first
  write-tests:
    name: "Step 1: Write Tests"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Write tests (without implementation)
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT: 
            1. Create a new branch for this TDD cycle
            2. Write ONLY tests for the requested feature
            3. Do NOT implement the functionality
            4. Tests should fail initially
            5. Focus on test coverage and edge cases
            6. Commit the tests to the new branch
          additional_permissions: |
            actions: read

  # Step 2: Write implementation
  write-implementation:
    name: "Step 2: Write Implementation"
    needs: write-tests
    if: always() && needs.write-tests.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Write implementation to pass tests
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT: 
            1. Switch to the existing TDD branch created in Step 1
            2. Write ONLY the implementation to pass the tests
            3. Do NOT modify the tests
            4. Make the tests pass with minimum required code
            5. Commit the implementation to the same branch
          additional_permissions: |
            actions: read

  # Step 3: Verify tests pass
  verify-tests:
    name: "Step 3: Verify Tests"
    needs: [write-tests, write-implementation]
    if: always() && needs.write-implementation.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run and verify all tests
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT: 
            1. Switch to the existing TDD branch from previous steps
            2. Run all tests and report results
            3. Fix any failing tests if needed
            4. Ensure all tests pass before completing
            5. Commit any test fixes to the same branch
            6. Create a Pull Request when all tests pass
          allowed_tools: "Bash(npm test),Bash(npm run test:*),Bash(jest),Bash(pytest),Bash(go test),Bash(cargo test)"
          additional_permissions: |
            actions: read