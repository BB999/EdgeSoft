name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  # Step 1: Write tests first
  write-tests:
    name: "Step 1: Write Tests"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Write tests (without implementation)
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT - TDD RED PHASE: 
            1. Create a new branch for this TDD cycle (format: claude/issue-{issue_number}-{timestamp})
            2. Write ONLY test files - NO implementation files whatsoever
            3. Do NOT create any source/implementation files (no .js/.py/.go files in src/ folder)
            4. Do NOT create placeholder classes or functions
            5. Tests should be comprehensive and cover all requirements
            6. Tests should reference non-existent functions/classes (they will be created in Step 2)
            7. Focus on edge cases, error handling, and full test coverage
            8. Commit ONLY the test files and package configuration to the branch
            9. Tests MUST fail when run (red phase of TDD)
          additional_permissions: |
            actions: read

  # Step 2: Write implementation
  write-implementation:
    name: "Step 2: Write Implementation"
    needs: write-tests
    if: always() && needs.write-tests.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Write implementation to pass tests
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT - TDD GREEN PHASE:
            1. Switch to the TDD branch created in Step 1 (claude/issue-{issue_number}-{timestamp})
            2. Run tests first to confirm they are failing (red phase)
            3. Write ONLY the minimal implementation to make tests pass
            4. Do NOT modify any test files
            5. Create only the necessary source/implementation files
            6. Implement functions/classes exactly as referenced in the tests
            7. Use minimal code - implement only what's needed to pass tests
            8. Run tests after implementation to confirm they pass (green phase)
            9. Commit the implementation files to the SAME branch as Step 1
            10. Include meaningful commit message describing the implementation
          additional_permissions: |
            actions: read

  # Step 3: Verify tests pass
  verify-tests:
    name: "Step 3: Verify Tests"
    needs: [write-tests, write-implementation]
    if: always() && needs.write-implementation.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run and verify all tests
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          custom_instructions: |
            IMPORTANT - TDD REFACTOR PHASE:
            1. Switch to the TDD branch from previous steps (claude/issue-{issue_number}-{timestamp})
            2. Run all tests to verify current state
            3. If tests are failing, analyze and fix the implementation (NOT the tests)
            4. Refactor code for better quality while keeping tests passing
            5. Ensure 100% test coverage and all tests pass
            6. Run any additional quality checks (linting, type checking if configured)
            7. Commit any refactoring/fixes to the SAME branch
            8. Create a Pull Request to main branch when all tests pass
            9. Include comprehensive PR description with TDD cycle summary
            10. Tag the original issue in the PR description
          allowed_tools: "Bash(npm test),Bash(npm run test:*),Bash(jest),Bash(pytest),Bash(go test),Bash(cargo test)"
          additional_permissions: |
            actions: read